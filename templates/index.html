<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Shifts Analyzer</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 40px;
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
    }
    
    .header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .header h1 {
        color: #333;
        font-size: 2.5em;
        margin-bottom: 10px;
    }
    
    .header p {
        color: #666;
        font-size: 1.1em;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 40px;
        gap: 20px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        border-radius: 25px;
        background: #f8f9fa;
        color: #6c757d;
        transition: all 0.3s ease;
    }

    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #6c757d;
    }

    .step.active .step-number {
        background: #667eea;
        color: white;
    }

    .step.completed .step-number {
        background: #28a745;
        color: white;
    }

    .step-text {
        font-weight: 500;
    }

    .step.active .step-text {
        color: #667eea;
    }

    /* Step 1: File Upload */
    .upload-section {
        display: block;
    }
    
    .drop-zone {
        border: 3px dashed #e1e1e1;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: #fafafa;
    }
    
    .drop-zone:hover,
    .drop-zone.dragover {
        border-color: #667eea;
        background: #f0f2ff;
    }
    
    .drop-zone i {
        font-size: 4em;
        color: #ccc;
        margin-bottom: 20px;
    }
    
    .drop-zone h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.5em;
    }
    
    .drop-zone p {
        color: #666;
        font-size: 1.1em;
    }
    
    .file-input {
        display: none;
    }
    
    .analyze-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 30px;
        width: 100%;
    }
    
    .analyze-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    .analyze-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .download-btn {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 10px 0;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .download-btn:hover {
        background: linear-gradient(135deg, #00a085 0%, #00b7b3 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 184, 148, 0.3);
    }

    .download-btn:disabled {
        background: #ddd;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Step 2: Heatmap */
    .heatmap-section {
        display: none;
    }

    .heatmap-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .heatmap {
        overflow-x: auto;
        position: relative;
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 10px;
        /* Ensure hardware acceleration for better scrolling performance */
        -webkit-overflow-scrolling: touch;
        will-change: scroll-position;
    }

    .heatmap table {
        position: relative; /* fix for sticky */
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 10px;
        /* Remove overflow: hidden as it can interfere with sticky positioning */
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        min-width: 1200px;
        width: max-content;
        table-layout: fixed; /* Added for better column control */
    }

    /* Sticky first column - simplified and strengthened */
    .heatmap th:first-child,
    .heatmap td:first-child {
        position: -webkit-sticky !important; /* For Safari */
        position: sticky !important;
        left: 0 !important;
        z-index: 2 !important;
        min-width: 180px;
        max-width: 220px;
        font-weight: 600;
        /* Add box-shadow for better visual separation */
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .heatmap th:first-child {
        background-color: #667eea !important;
        color: white;
        z-index: 3 !important; /* Higher z-index to stay on top */
        font-weight: 700;
    }

    .heatmap th,
    .heatmap td {
        padding: 12px 15px;
        text-align: center;
        border: 1px solid #e9ecef;
        min-width: 120px;
        white-space: nowrap;
        position: relative;
    }

    .heatmap th {
        background: #667eea;
        color: white;
        font-weight: 600;
        font-size: 0.9em;
    }

    .heatmap td.employee-name {
        background-color: #f8f9fa !important;
        font-weight: 600;
        text-align: left;
        color: #333;
    }

    .heatmap-cell {
        min-width: 40px;
        border-radius: 5px;
        font-weight: bold;
        color: white;
        transition: all 0.3s ease;
    }

        /* Step 3: Employee Selection */
        .employee-section {
            display: none;
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .employee-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .employee-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
        }

        .employee-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .employee-name {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .employee-stats {
            color: #666;
            font-size: 0.95em;
        }

        .employee-card.selected .employee-name,
        .employee-card.selected .employee-stats {
            color: white;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .download-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 3em;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
        }

        .file-item i {
            color: #667eea;
            margin-right: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* Interactive Heatmap Headers */
        .heatmap th {
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        .heatmap th:hover {
            background: #5a67d8 !important;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .sort-indicator {
            font-size: 0.8em;
            opacity: 0.7;
        }

        .column-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 10px;
            min-width: 200px;
            display: none;
            color: #333; /* Fix: Ensure menu text is dark */
        }

        .column-menu.show {
            display: block;
        }

        .menu-section {
            margin-bottom: 15px;
        }

        .menu-section:last-child {
            margin-bottom: 0;
        }

        .menu-section h4 {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .menu-option {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #333; /* Fix: Set text color to dark */
        }

        .menu-option:hover {
            background: #f8f9fa;
            color: #333; /* Ensure text stays dark on hover */
        }

        .menu-option.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .menu-option i {
            width: 12px;
            font-size: 0.8em;
        }

        .filter-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            color: #333; /* Fix: Set input text color */
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 20px;
        }

        .filter-chip {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-chip .remove {
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7em;
        }

        .filter-chip .remove:hover {
            background: rgba(255,255,255,0.5);
        }

        .heatmap table.sorted {
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .heatmap table.sorted.loaded {
            opacity: 1;
        }
        
        /* Ensure sticky column maintains styling during transitions */
        .heatmap table.sorted th:first-child,
        .heatmap table.sorted td:first-child,
        .heatmap table.sorted.loaded th:first-child,
        .heatmap table.sorted.loaded td:first-child {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
        }
        
        /* Fix for hover state of sticky column cells */
        .heatmap tr:hover td:first-child {
            background-color: #eef2ff !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóìÔ∏è Employee Shifts Analyzer</h1>
            <p>Upload documents, view heatmap, and generate individual reports</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step active" id="step-1-indicator">
                <div class="step-number">1</div>
                <div class="step-text">Upload Files</div>
            </div>
            <div class="step" id="step-2-indicator">
                <div class="step-number">2</div>
                <div class="step-text">View Heatmap</div>
            </div>
            <div class="step" id="step-3-indicator">
                <div class="step-number">3</div>
                <div class="step-text">Select Employee</div>
            </div>
        </div>

        <!-- Step 1: File Upload -->
        <div class="upload-section" id="step1">
            <div class="drop-zone" id="dropZone">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Upload Shift Documents</h3>
                <p>Drag and drop your .docx files here or click to browse</p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".docx">
            </div>
            
            <div class="file-list" id="fileList"></div>
            
            <button class="analyze-btn" id="analyzeBtn" disabled>
                <i class="fas fa-chart-line"></i> Analyze Files
            </button>
        </div>

        <!-- Step 2: Heatmap -->
        <div class="heatmap-section" id="step2">
            <button class="back-btn" onclick="goToStep(1)">
                <i class="fas fa-arrow-left"></i> Back to Upload
            </button>
            
            <div class="heatmap-container">
                <h2 style="margin-bottom: 20px; color: #333;">üìä Shift Distribution Heatmap</h2>
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Click on column headers to sort and filter data
                </p>
                
                <!-- Active Filters Display -->
                <div class="filter-chips" id="activeFilters" style="display: none;">
                    <strong style="color: #333; margin-right: 10px;">Active Filters:</strong>
                </div>
                
                <div class="heatmap" id="heatmapContainer"></div>
                
                <!-- Download button (initially hidden) -->
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="download-btn" id="downloadHeatmapBtn" onclick="downloadHeatmapAsPNG()" style="display: none;">
                        <i class="fas fa-save"></i> Save Heatmap PNG to Downloads
                    </button>
                </div>
            </div>
            
            <button class="analyze-btn" onclick="goToStep(3)">
                <i class="fas fa-user-check"></i> Select Employee for Report
            </button>
        </div>

        <!-- Step 3: Employee Selection -->
        <div class="employee-section" id="step3">
            <button class="back-btn" onclick="goToStep(2)">
                <i class="fas fa-arrow-left"></i> Back to Heatmap
            </button>
            
            <h2 style="margin-bottom: 20px; color: #333;">üë• Select Employee for Detailed Report</h2>
            <div class="employee-grid" id="employeeGrid"></div>
            
            <button class="download-btn" id="downloadBtn" disabled>
                <i class="fas fa-download"></i> Generate & Download Report
            </button>
        </div>

        <!-- Loading indicator -->
        <div class="loading" id="loading">
            <i class="fas fa-spinner"></i>
            <h3 style="margin-top: 20px; color: #667eea;">Processing...</h3>
            <p style="color: #666;">Please wait while we analyze your files</p>
        </div>
    </div>

    <!-- Include html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        let currentStep = 1;
        let sessionId = null;
        let employeeData = {};
        let originalEmployeeData = {};
        let selectedEmployee = null;
        let currentSort = { column: null, order: 'asc' };
        let activeFilters = {};
        let hiddenColumns = new Set();

        // Step navigation
        function goToStep(step) {
            // Hide all sections
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            
            // Update step indicators
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 < step) {
                    s.classList.add('completed');
                } else if (i + 1 === step) {
                    s.classList.add('active');
                }
            });
            
            // Show current step
            document.getElementById(`step${step}`).style.display = 'block';
            currentStep = step;
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const analyzeBtn = document.getElementById('analyzeBtn');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.docx'));
            handleFiles(files);
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            fileList.innerHTML = '';
            
            if (files.length === 0) {
                analyzeBtn.disabled = true;
                return;
            }
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-file-word"></i>
                        <span>${file.name}</span>
                    </div>
                    <span style="color: #666; font-size: 0.9em;">${formatFileSize(file.size)}</span>
                `;
                fileList.appendChild(fileItem);
            });
            
            analyzeBtn.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Analyze files
        analyzeBtn.addEventListener('click', analyzeFiles);

        async function analyzeFiles() {
            const files = fileInput.files;
            console.log('analyzeFiles invoked with', files.length, 'files');
            if (files.length === 0) { console.warn('No files selected'); return; }

            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('step1').style.display = 'none';

            try {
                console.log('Sending /analyze request');
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                console.log('Analyze response status', response.status);
                const text = await response.text();
                console.log('Raw analyze response text:', text.slice(0,500));
                let data;
                try { data = JSON.parse(text); } catch(parseErr){ console.error('JSON parse error', parseErr); alert('Analyze parse error'); goToStep(1); return; }

                if (data.success) {
                    console.log('Analyze success payload', data);
                    sessionId = data.session_dir;
                    employeeData = data.summary;
                    originalEmployeeData = JSON.parse(JSON.stringify(data.summary)); // Deep copy
                    console.log('Employee data keys:', Object.keys(employeeData));
                    displayHeatmap(data.summary);
                    goToStep(2);
                } else {
                    console.error('Analyze error field', data.error);
                    alert('Error: ' + data.error);
                    goToStep(1);
                }
            } catch (error) {
                console.error('Analyze fetch exception', error);
                alert('Error analyzing files: ' + error.message);
                goToStep(1);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Display heatmap with interactive headers
        function displayHeatmap(data) {
            console.log('displayHeatmap called with data', data);
            const container = document.getElementById('heatmapContainer');
            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = '<p style="color:#c00; padding:20px;">No shift data extracted. Check that uploaded .docx files follow expected format.</p>';
                return;
            }
            
            // Get all unique shift types (excluding hidden ones)
            const allShiftTypes = new Set();
            Object.values(data).forEach(employee => {
                Object.keys(employee).forEach(shift => {
                    if (!hiddenColumns.has(shift)) {
                        allShiftTypes.add(shift);
                    }
                });
            });
            
            const shiftTypes = Array.from(allShiftTypes).sort();

            // Ensure download buttons are visible after first render
            const dlBtn = document.getElementById('downloadHeatmapBtn');
            const svBtn = document.getElementById('saveServerHeatmapBtn');
            if (dlBtn) dlBtn.style.display = 'inline-block';
            if (svBtn) svBtn.style.display = 'inline-block';
            
            // Create table with interactive headers
            let html = '<table class="sorted"><thead><tr>';
            
            // Employee name header
            html += `<th onclick="showColumnMenu(event, 'employee')" data-column="employee">
                        <div class="header-content">
                            <span>Employee</span>
                            <span class="sort-indicator">${getSortIndicator('employee')}</span>
                        </div>
                        ${createColumnMenu('employee', 'text')}
                     </th>`;
            
            // Shift type headers
            shiftTypes.forEach(shift => {
                html += `<th onclick="showColumnMenu(event, '${shift}')" data-column="${shift}">
                            <div class="header-content">
                                <span>${shift}</span>
                                <span class="sort-indicator">${getSortIndicator(shift)}</span>
                            </div>
                            ${createColumnMenu(shift, 'number')}
                         </th>`;
            });
            
            // Total header
            html += `<th onclick="showColumnMenu(event, 'total')" data-column="total">
                        <div class="header-content">
                            <span>Total</span>
                            <span class="sort-indicator">${getSortIndicator('total')}</span>
                        </div>
                        ${createColumnMenu('total', 'number')}
                     </th>`;
            
            html += '</tr></thead><tbody>';
            
            // Add rows for each employee
            Object.entries(data).forEach(([employee, shifts]) => {
                const totalShifts = Object.values(shifts).reduce((sum, count) => sum + count, 0);
                html += `<tr><td class="employee-name">${employee}</td>`;
                
                shiftTypes.forEach(shiftType => {
                    const count = shifts[shiftType] || 0;
                    const intensity = Math.min(count / 10, 1); // Normalize to 0-1
                    const color = count > 0 ? 
                        `rgba(102, 126, 234, ${0.3 + intensity * 0.7})` : 
                        '#f8f9fa';
                    html += `<td class="heatmap-cell" style="background-color: ${color}; color: ${count > 5 ? 'white' : '#333'}">${count || ''}</td>`;
                });
                
                html += `<td class="heatmap-cell" style="background-color: #28a745; color: white; font-weight: bold;">${totalShifts}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Show download button now that heatmap is populated
            const downloadBtn = document.getElementById('downloadHeatmapBtn');
            if (downloadBtn) {
                downloadBtn.style.display = 'inline-flex';
            }
            
            // Add loaded class after a short delay for animation
            setTimeout(() => {
                const table = container.querySelector('table');
                if (table) table.classList.add('loaded');
            }, 100);
            
            // Update active filters display
            updateActiveFiltersDisplay();
            
            // Ensure sticky behavior is applied even after table is populated
            setTimeout(() => {
                ensureStickyColumn();
            }, 200);
        }
        
        // Function to ensure sticky column behavior with enhanced robustness
        function ensureStickyColumn() {
            const firstCells = document.querySelectorAll('.heatmap th:first-child, .heatmap td:first-child');
            firstCells.forEach(cell => {
                // Apply inline styles with !important to override any conflicting styles
                cell.style.setProperty('position', 'sticky', 'important');
                cell.style.setProperty('left', '0', 'important');
                
                if (cell.tagName === 'TH') {
                    cell.style.setProperty('z-index', '3', 'important');
                    cell.style.setProperty('background-color', '#667eea', 'important');
                } else {
                    cell.style.setProperty('z-index', '2', 'important');
                    // Use the employee-name background color for consistency
                    cell.style.setProperty('background-color', '#f8f9fa', 'important');
                    
                    // Add shadow for visual separation
                    cell.style.setProperty('box-shadow', '2px 0 5px rgba(0,0,0,0.1)', 'important');
                }
            });
            
            // Add scroll event listener to handle sticky column during horizontal scrolling
            const heatmapContainer = document.querySelector('.heatmap');
            if (heatmapContainer) {
                // Remove previous listener if any
                heatmapContainer.onscroll = null;
                
                // Add new scroll listener
                heatmapContainer.onscroll = function() {
                    // This triggers a repaint which helps fix sticky column rendering issues
                    firstCells.forEach(cell => {
                        cell.style.setProperty('transform', 'translateZ(0)');
                    });
                };
            }
        }

        // Create column menu HTML
        function createColumnMenu(column, type) {
            const filterId = `filter-${column.replace(/\s+/g, '-')}`;
            return `
                <div class="column-menu" data-column="${column}">
                    <div class="menu-section">
                        <h4>Sort</h4>
                        <div class="menu-option ${currentSort.column === column && currentSort.order === 'asc' ? 'active' : ''}" 
                             onclick="sortColumn('${column}', 'asc')">
                            <i class="fas fa-sort-alpha-down"></i>
                            <span>Sort A-Z ${type === 'number' ? '(Low-High)' : ''}</span>
                        </div>
                        <div class="menu-option ${currentSort.column === column && currentSort.order === 'desc' ? 'active' : ''}" 
                             onclick="sortColumn('${column}', 'desc')">
                            <i class="fas fa-sort-alpha-up"></i>
                            <span>Sort Z-A ${type === 'number' ? '(High-Low)' : ''}</span>
                        </div>
                    </div>
                    
                    ${column !== 'employee' ? `
                        <div class="menu-section">
                            <h4>Filter</h4>
                            ${type === 'number' ? `
                                <div class="menu-option" onclick="applyNumberFilter('${column}', 'min')">
                                    <i class="fas fa-filter"></i>
                                    <span>Filter by minimum...</span>
                                </div>
                                <div class="menu-option" onclick="applyNumberFilter('${column}', 'hide')">
                                    <i class="fas fa-eye-slash"></i>
                                    <span>Hide zero values</span>
                                </div>
                            ` : ''}
                            ${column !== 'total' ? `
                                <div class="menu-option" onclick="hideColumn('${column}')">
                                    <i class="fas fa-times"></i>
                                    <span>Hide column</span>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Get sort indicator for column
        function getSortIndicator(column) {
            if (currentSort.column === column) {
                return currentSort.order === 'asc' ? '‚Üë' : '‚Üì';
            }
            return '';
        }

        // Show column menu
        function showColumnMenu(event, column) {
            event.stopPropagation();
            
            // Hide all other menus
            document.querySelectorAll('.column-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Show current menu
            const menu = event.currentTarget.querySelector('.column-menu');
            menu.classList.add('show');
            
            // Prevent menu from closing when clicking inside it
            menu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.classList.remove('show');
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        // Sort column
        function sortColumn(column, order) {
            currentSort = { column, order };
            applyFiltersAndSort();
            
            // Close menu
            document.querySelector('.column-menu.show')?.classList.remove('show');
        }

        // Apply text filter
        function applyTextFilter(column, value) {
            if (value.trim()) {
                activeFilters[column] = value.trim();
            } else {
                delete activeFilters[column];
            }
            applyFiltersAndSort();
        }

        // Apply number filter
        function applyNumberFilter(column, type) {
            if (type === 'min') {
                const value = prompt('Enter minimum value:');
                if (value !== null && !isNaN(value) && value.trim() !== '') {
                    activeFilters[column] = { type: 'min', value: parseInt(value) };
                    applyFiltersAndSort();
                }
            } else if (type === 'hide') {
                activeFilters[column] = { type: 'hideZero', value: true };
                applyFiltersAndSort();
            }
            
            // Close menu
            document.querySelector('.column-menu.show')?.classList.remove('show');
        }

        // Hide column
        function hideColumn(column) {
            hiddenColumns.add(column);
            applyFiltersAndSort();
            
            // Close menu
            document.querySelector('.column-menu.show')?.classList.remove('show');
        }

        // Apply all filters and sorting
        function applyFiltersAndSort() {
            let filteredData = JSON.parse(JSON.stringify(originalEmployeeData)); // Deep copy
            
            // Apply number filters for shift types and total
            Object.keys(filteredData).forEach(employee => {
                let shouldKeep = true;
                
                // Number filters for shift types and total
                Object.keys(activeFilters).forEach(filterColumn => {
                    const filter = activeFilters[filterColumn];
                    if (typeof filter === 'object') {
                        let value;
                        if (filterColumn === 'total') {
                            value = Object.values(filteredData[employee]).reduce((sum, count) => sum + count, 0);
                        } else {
                            value = filteredData[employee][filterColumn] || 0;
                        }
                        
                        if (filter.type === 'min' && value < filter.value) {
                            shouldKeep = false;
                        } else if (filter.type === 'hideZero' && value === 0) {
                            shouldKeep = false;
                        }
                    }
                });
                
                if (!shouldKeep) {
                    delete filteredData[employee];
                }
            });
            
            // Sort the data
            if (currentSort.column) {
                const sortedEntries = Object.entries(filteredData).sort((a, b) => {
                    let valueA, valueB;
                    
                    if (currentSort.column === 'employee') {
                        valueA = a[0].toLowerCase();
                        valueB = b[0].toLowerCase();
                    } else if (currentSort.column === 'total') {
                        valueA = Object.values(a[1]).reduce((sum, count) => sum + count, 0);
                        valueB = Object.values(b[1]).reduce((sum, count) => sum + count, 0);
                    } else {
                        valueA = a[1][currentSort.column] || 0;
                        valueB = b[1][currentSort.column] || 0;
                    }
                    
                    if (currentSort.order === 'desc') {
                        return valueA < valueB ? 1 : (valueA > valueB ? -1 : 0);
                    } else {
                        return valueA > valueB ? 1 : (valueA < valueB ? -1 : 0);
                    }
                });
                
                // Convert back to object
                const sortedData = {};
                sortedEntries.forEach(([employee, shifts]) => {
                    sortedData[employee] = shifts;
                });
                filteredData = sortedData;
            }
            
            // Update employee data for step 3
            employeeData = filteredData;
            
            // Display the filtered and sorted heatmap
            displayHeatmap(filteredData);
            
            // Ensure sticky column behavior is maintained after filtering/sorting
            setTimeout(ensureStickyColumn, 100);
        }

        // Update active filters display
        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeFilters');
            const hasFilters = Object.keys(activeFilters).length > 0 || hiddenColumns.size > 0;
            
            if (!hasFilters) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            // Clear existing chips (except the label)
            const existingChips = container.querySelectorAll('.filter-chip');
            existingChips.forEach(chip => chip.remove());
            
            // Add filter chips
            Object.keys(activeFilters).forEach(column => {
                const filter = activeFilters[column];
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                
                let text = `${column}: `;
                if (typeof filter === 'string') {
                    text += `"${filter}"`;
                } else if (filter.type === 'min') {
                    text += `‚â• ${filter.value}`;
                } else if (filter.type === 'hideZero') {
                    text += 'hide zeros';
                }
                
                chip.innerHTML = `
                    ${text}
                    <span class="remove" onclick="removeFilter('${column}')">√ó</span>
                `;
                container.appendChild(chip);
            });
            
            // Add hidden column chips
            hiddenColumns.forEach(column => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                chip.innerHTML = `
                    Hidden: ${column}
                    <span class="remove" onclick="showColumn('${column}')">√ó</span>
                `;
                container.appendChild(chip);
            });
        }

        // Remove filter
        function removeFilter(column) {
            delete activeFilters[column];
            applyFiltersAndSort();
        }

        // Show hidden column
        function showColumn(column) {
            hiddenColumns.delete(column);
            applyFiltersAndSort();
        }

        // Navigate to employee selection and populate grid
        function goToStep3() {
            const grid = document.getElementById('employeeGrid');
            grid.innerHTML = '';
            
            Object.entries(employeeData).forEach(([employee, shifts]) => {
                const totalShifts = Object.values(shifts).reduce((sum, count) => sum + count, 0);
                const shiftTypes = Object.keys(shifts).length;
                
                const card = document.createElement('div');
                card.className = 'employee-card';
                card.innerHTML = `
                    <div class="employee-name">${employee}</div>
                    <div class="employee-stats">
                        ${totalShifts} total shifts<br>
                        ${shiftTypes} shift types
                    </div>
                `;
                
                card.addEventListener('click', () => selectEmployee(employee, card));
                grid.appendChild(card);
            });
            
            goToStep(3);
        }

        // Override the step 3 navigation
        document.querySelector('button[onclick="goToStep(3)"]').onclick = goToStep3;

        function selectEmployee(employee, cardElement) {
            // Remove previous selection
            document.querySelectorAll('.employee-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select current card
            cardElement.classList.add('selected');
            selectedEmployee = employee;
            document.getElementById('downloadBtn').disabled = false;
        }

        // Generate report
        const reportDownloadBtn = document.getElementById('downloadBtn');
        if (reportDownloadBtn) {
            console.log('Found downloadBtn, adding event listener');
            reportDownloadBtn.addEventListener('click', generateReport);
        } else {
            console.error('downloadBtn not found');
        }

        async function generateReport() {
            console.log('generateReport called');
            console.log('selectedEmployee:', selectedEmployee);
            console.log('sessionId:', sessionId);
            
            if (!selectedEmployee || !sessionId) {
                alert('Please select an employee first.');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            try {
                const formData = new FormData();
                formData.append('employee_name', selectedEmployee);
                formData.append('session_id', sessionId);

                console.log('Sending request to /upload with:', {
                    employee_name: selectedEmployee,
                    session_id: sessionId
                });

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    const absoluteUrl = data.download_url.startsWith('http') ? data.download_url : `${location.origin}${data.download_url}`;

                    async function forceBlobDownload(url, filename) {
                        try {
                            const r = await fetch(url, {cache: 'no-store'});
                            if (!r.ok) throw new Error('HTTP '+r.status);
                            const blob = await r.blob();
                            const objectUrl = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = objectUrl;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => { URL.revokeObjectURL(objectUrl); a.remove(); }, 1500);
                            return true;
                        } catch (e) {
                            console.error('forceBlobDownload failed', e);
                            return false;
                        }
                    }

                    // Try blob method first (most reliable inside pywebview)
                    forceBlobDownload(absoluteUrl, `${selectedEmployee}_shifts.xlsx`).then(ok => {
                        if (!ok) {
                            const apiUrl = absoluteUrl.replace('/download/', '/api/download/');
                            forceBlobDownload(apiUrl, `${selectedEmployee}_shifts.xlsx`).then(apiOk => {
                                if (!apiOk) {
                                    window.location.href = absoluteUrl;
                                    setTimeout(() => {
                                        fetch(absoluteUrl, { method: 'HEAD' }).then(r => {
                                            if (!r.ok) {
                                                window.open(absoluteUrl, '_blank');
                                            }
                                        }).catch(()=>window.open(absoluteUrl, '_blank'));
                                    }, 1200);
                                }
                            });
                        }
                    });
                    
                    // Optional: Show success message
                    alert(`Report generated successfully! ${data.message}. Saved to${data.saved_path}`);
                } else {
                    alert('Error generating report: ' + data.error);
                }
            } catch (error) {
                console.error('Error in generateReport:', error);
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Function to download heatmap as PNG
        async function downloadHeatmapAsPNG() {
            // Repurpose client button to call server save silently (no navigation)
            const downloadBtn = document.getElementById('downloadHeatmapBtn');
            const serverBtn = document.getElementById('saveServerHeatmapBtn');
            if(!employeeData || Object.keys(employeeData).length===0){
                alert('No heatmap data yet. Run analysis first.');
                return;
            }
            downloadBtn.disabled = true; if(serverBtn) serverBtn.disabled = true;
            const original = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving PNG...';
            try {
                const res = await fetch('/api/heatmap_save', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ summary: employeeData })
                });
                const data = await res.json();
                if(res.ok && data.success){
                    alert('Heatmap saved to: ' + data.saved_path);
                } else {
                    alert('Save failed: ' + (data.error || res.status));
                }
            } catch(err){
                console.error('Server save error', err);
                alert('Error: ' + err.message);
            } finally {
                downloadBtn.disabled = false; if(serverBtn) serverBtn.disabled = false;
                downloadBtn.innerHTML = original;
            }
        }

        // Server-side save (no navigation) using /api/heatmap_save
        async function saveServerHeatmapPNG(){
            const btn = document.getElementById('saveServerHeatmapBtn');
            const downloadBtn = document.getElementById('downloadHeatmapBtn');
            if(!employeeData || Object.keys(employeeData).length===0){
                alert('No data yet. Analyze files first.');
                return;
            }
            btn.disabled = true; if(downloadBtn) downloadBtn.disabled = true;
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving PNG...';
            try{
                const res = await fetch('/api/heatmap_save', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ summary: employeeData })
                });
                const data = await res.json();
                if(res.ok && data.success){
                    alert('Saved heatmap to: ' + data.saved_path);
                } else {
                    alert('Server save failed: ' + (data.error || res.status));
                }
            }catch(err){
                console.error('Server save error', err);
                alert('Error: ' + err.message);
            } finally {
                btn.disabled = false; if(downloadBtn) downloadBtn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        // Manual table -> PNG renderer (no external libs)
        function manualRenderTableToPNG(table) {
            const rows = Array.from(table.querySelectorAll('tr'));
            if (!rows.length) throw new Error('Empty table');
            const ctxInfoRow = rows[0];
            const colCount = ctxInfoRow.children.length;
            const colWidths = [];
            // Compute widths based on live table
            rows[0].querySelectorAll('th,td').forEach(cell => {
                colWidths.push(cell.getBoundingClientRect().width || 120);
            });
            const rowHeights = rows.map(r => r.getBoundingClientRect().height || 32);
            const paddingX = 12; const paddingY = 8;
            const totalWidth = colWidths.reduce((a,b)=>a+b,0) + 2;
            const totalHeight = rowHeights.reduce((a,b)=>a+b,0) + 2;
            const scale = 2;
            const canvas = document.createElement('canvas');
            canvas.width = Math.floor(totalWidth*scale);
            canvas.height = Math.floor(totalHeight*scale);
            const ctx = canvas.getContext('2d');
            ctx.scale(scale,scale);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0,0,totalWidth,totalHeight);
            ctx.font = '14px "Segoe UI", Arial, sans-serif';
            ctx.textBaseline = 'middle';
            let y=1;
            rows.forEach((row,rowIdx)=>{
                let x=1; const cells = Array.from(row.children);
                cells.forEach((cell,colIdx)=>{
                    const w = colWidths[colIdx];
                    const h = rowHeights[rowIdx];
                    // Background
                    let bg = window.getComputedStyle(cell).backgroundColor;
                    if (!bg || bg==='rgba(0, 0, 0, 0)' || bg==='transparent') bg = rowIdx===0? '#667eea':'#ffffff';
                    ctx.fillStyle = bg;
                    ctx.fillRect(x,y,w,h);
                    // Text
                    let text = cell.textContent.trim();
                    ctx.fillStyle = (rowIdx===0)? '#ffffff':'#333333';
                    if (/rgba?\((\d+), (\d+), (\d+), ([0-9.]+)\)/.test(bg)) {
                        // If dark background lighten text
                        try {
                            const m = bg.match(/rgba?\(([^)]+)\)/)[1].split(',').map(v=>parseFloat(v));
                            const lum = 0.2126*m[0]+0.7152*m[1]+0.0722*m[2];
                            if (lum<128) ctx.fillStyle = '#ffffff';
                        } catch(e){}
                    }
                    const cellText = text;
                    // Simple clipping
                    const maxWidth = w - paddingX*2;
                    let display = cellText;
                    while (ctx.measureText(display).width > maxWidth && display.length>3) {
                        display = display.slice(0,-2);
                    }
                    if (display !== cellText) display += '‚Ä¶';
                    ctx.fillText(display, x+paddingX, y + h/2);
                    // Border
                    ctx.strokeStyle = '#e0e0e0';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x,y,w,h);
                    x += w;
                });
                y += rowHeights[rowIdx];
            });
            const saveName = `shifts-heatmap-${new Date().toISOString().split('T')[0]}-fallback.png`;
            if (canvas.toBlob) {
                canvas.toBlob(blob => {
                    const objectUrl = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = objectUrl;
                    a.download = saveName;
                    document.body.appendChild(a); a.click();
                    setTimeout(()=>{URL.revokeObjectURL(objectUrl); a.remove();}, 1500);
                }, 'image/png', 0.92);
            } else {
                const dataURL = canvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = saveName;
                document.body.appendChild(a); a.click(); a.remove();
            }
            alert('PNG generated (fallback renderer).');
        }
        
        // Add window resize handler to maintain sticky column behavior
        window.addEventListener('resize', function() {
            // Slight delay to let the layout stabilize
            setTimeout(ensureStickyColumn, 100);
        });
        
        // Call ensureStickyColumn on page load to initialize sticky behavior
        window.addEventListener('load', ensureStickyColumn);
    </script>
</body>
</html>
